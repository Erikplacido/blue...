/**
 * Booking App v4.0 - Vers√£o corrigida para resolver erros de elementos ausentes
 * Corrige todos os problemas identificados no console
 */
class BookingApp {
    constructor() {
        this.elements = {};
        this.initialized = false;
        this.debugMode = window.BlueProject?.debug || false;
    }

    init() {
        try {
            console.log('üöÄ Inicializando BookingApp v4.0 (Fixed)');
            
            this.findElements();
            this.setupEventListeners();
            this.initializePricing();
            
            this.initialized = true;
            console.log('‚úÖ BookingApp inicializado com sucesso');
            
        } catch (error) {
            console.error('‚ùå Erro ao inicializar BookingApp:', error);
            this.initializeFallback();
        }
    }

    findElements() {
        // Lista de elementos opcionais que podem n√£o existir
        const elementMap = {
            // Elementos obrigat√≥rios
            summaryTotal: '#summaryTotal',
            summaryBar: '#summaryBar', 
            openSummaryBtn: '#openSummaryBtn',
            summaryModal: '#summaryModal',
            
            // Elementos opcionais
            calendarPreview: '#calendarPreview',
            totalPriceLabel: '#totalPriceLabel',
            contractPreview: '#contractPreview',
            discountCodeModal: '#discountCodeModal',
            pointsApplied: '#pointsApplied'
        };
        
        for (const [key, selector] of Object.entries(elementMap)) {
            const element = document.querySelector(selector);
            if (element) {
                this.elements[key] = element;
                if (this.debugMode) console.log(`‚úÖ Elemento encontrado: ${selector}`);
            } else {
                console.warn(`‚ö†Ô∏è Elemento n√£o encontrado: ${selector}`);
                // Criar elemento placeholder se cr√≠tico
                if (['summaryTotal', 'summaryBar', 'openSummaryBtn'].includes(key)) {
                    this.elements[key] = this.createPlaceholder(key, selector);
                }
            }
        }
        
        console.log('üìã Elementos encontrados:', Object.keys(this.elements));
    }

    createPlaceholder(key, selector) {
        console.log(`üîß Criando placeholder para ${key}`);
        const placeholder = document.createElement('div');
        placeholder.id = selector.replace('#', '');
        placeholder.className = 'placeholder-element';
        placeholder.setAttribute('data-placeholder', 'true');
        placeholder.style.display = 'none'; // Esconder por padr√£o
        document.body.appendChild(placeholder);
        return placeholder;
    }

    setupEventListeners() {
        // S√≥ configurar listeners para elementos que existem
        if (this.elements.openSummaryBtn) {
            this.elements.openSummaryBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.openSummaryModal();
            });
            console.log('‚úÖ Listener configurado para openSummaryBtn');
        }
        
        // Calendar preview (opcional)
        if (this.elements.calendarPreview) {
            if (typeof this.elements.calendarPreview.addEventListener === 'function') {
                this.elements.calendarPreview.addEventListener('click', () => {
                    if (window.bookingCalendar) {
                        window.bookingCalendar.show();
                    }
                });
                console.log('‚úÖ Listener configurado para calendarPreview');
            } else {
                console.warn('‚ö†Ô∏è calendarPreview n√£o tem addEventListener');
            }
        }
        
        // Discount code (opcional)
        if (this.elements.discountCodeModal) {
            this.elements.discountCodeModal.addEventListener('input', 
                this.debounce(() => this.validateDiscountCode(), 500)
            );
            console.log('‚úÖ Listener configurado para discountCodeModal');
        }
        
        console.log('üîó Event listeners configurados');
    }

    initializePricing() {
        // Aguardar um pouco mais para garantir que pricing-calculator.js carregue
        setTimeout(() => {
            console.log('üîç Verificando sistemas de pricing dispon√≠veis...');
            
            // Verificar se PricingCalculator est√° dispon√≠vel
            if (window.PricingCalculator && typeof window.PricingCalculator.calculateTotal === 'function') {
                try {
                    window.PricingCalculator.calculateTotal();
                    console.log('‚úÖ PricingCalculator inicializado e funcionando');
                } catch (error) {
                    console.error('‚ùå Erro ao executar PricingCalculator:', error);
                    this.initializeFallbackPricing();
                }
            }
            // Verificar se updateTotal est√° dispon√≠vel
            else if (window.updateTotal && typeof window.updateTotal === 'function') {
                try {
                    window.updateTotal(true);
                    console.log('‚úÖ updateTotal executado com sucesso');
                } catch (error) {
                    console.error('‚ùå Erro ao executar updateTotal:', error);
                    this.initializeFallbackPricing();
                }
            }
            // Verificar se updatePricing est√° dispon√≠vel
            else if (window.updatePricing && typeof window.updatePricing === 'function') {
                try {
                    window.updatePricing();
                    console.log('‚úÖ updatePricing executado com sucesso');
                } catch (error) {
                    console.error('‚ùå Erro ao executar updatePricing:', error);
                    this.initializeFallbackPricing();
                }
            } else {
                console.warn('‚ö†Ô∏è Nenhum sistema de pricing encontrado, aguardando mais tempo...');
                
                // Tentar novamente ap√≥s mais tempo
                setTimeout(() => {
                    if (window.PricingCalculator || window.updateTotal || window.updatePricing) {
                        console.log('‚úÖ Sistema de pricing encontrado ap√≥s espera adicional');
                        this.initializePricing();
                    } else {
                        console.warn('‚ö†Ô∏è Sistema de pricing ainda n√£o encontrado, inicializando fallback...');
                        this.initializeFallbackPricing();
                    }
                }, 1000);
            }
        }, 800); // Aumentado para 800ms para aguardar carregamento do pricing-calculator.js
    }

    initializeFallbackPricing() {
        // ‚úÖ CORRIGIDO: Sistema b√°sico de pricing calculando servi√ßos inclusos
        const calculateBasicTotal = () => {
            let total = 0; // ‚úÖ CORRIGIDO: Come√ßar de zero
            
            // Calcular servi√ßos inclusos dinamicamente
            document.querySelectorAll('.item-card').forEach(el => {
                const price = parseFloat(el.getAttribute('data-price') || 0);
                const qtyElement = el.querySelector('.qty');
                const qty = parseInt(qtyElement?.textContent || '0', 10);
                
                if (qty > 0 && !isNaN(price)) {
                    total += price * qty;
                    const itemName = el.querySelector('h4')?.textContent?.trim() || 'Item';
                    console.log(`üìä Fallback - ${itemName}: $${price} √ó ${qty} = $${(price * qty).toFixed(2)}`);
                }
            });
            
            // Se n√£o encontrou nenhum item, erro cr√≠tico - n√£o deve acontecer em sistema din√¢mico
            if (total === 0) {
                console.error('‚ùå CRITICAL: No pricing data found - dynamic pricing system failure');
                console.error('üìä This indicates a database connectivity or configuration issue');
                
                // Mostrar erro ao usu√°rio em vez de fallback
                const summaryTotal = document.getElementById('summaryTotal');
                if (summaryTotal) {
                    summaryTotal.textContent = 'Error';
                    summaryTotal.style.color = '#ff6b6b';
                }
                return; // N√£o continuar com c√°lculos
            }
            
            const summaryTotal = document.getElementById('summaryTotal');
            const totalPriceLabel = document.getElementById('totalPriceLabel');
            
            if (summaryTotal) {
                summaryTotal.textContent = `$${total.toFixed(2)}`;
                summaryTotal.setAttribute('data-current-value', total.toFixed(2));
            }
            
            if (totalPriceLabel) {
                totalPriceLabel.textContent = `$${total.toFixed(2)}`;
            }
            
            console.log('‚úÖ Fallback pricing aplicado:', total);
        };
        
        // Executar c√°lculo inicial
        calculateBasicTotal();
        
        // Criar sistema global de fallback
        window.updatePricing = calculateBasicTotal;
        window.recalculateEmergency = calculateBasicTotal;
        
        console.log('‚úÖ Sistema de pricing fallback inicializado');
    }

    openSummaryModal() {
        if (this.elements.summaryModal) {
            this.elements.summaryModal.classList.remove('hidden');
            this.elements.summaryModal.setAttribute('aria-hidden', 'false');
            
            // Atualizar conte√∫do se SummaryModal existir
            if (window.SummaryModal && typeof window.SummaryModal.update === 'function') {
                try {
                    window.SummaryModal.update();
                } catch (error) {
                    console.error('‚ùå Erro ao atualizar SummaryModal:', error);
                }
            }
            
            console.log('‚úÖ Summary modal aberto');
        } else {
            console.warn('‚ö†Ô∏è summaryModal n√£o encontrado');
        }
    }

    initializeFallback() {
        console.log('üîß Inicializando sistema de fallback...');
        
        // Garantir que bot√£o de checkout funcione
        const button = document.getElementById('openSummaryBtn');
        const modal = document.getElementById('summaryModal');
        
        if (button && modal) {
            button.onclick = function(e) {
                e.preventDefault();
                modal.classList.remove('hidden');
                modal.setAttribute('aria-hidden', 'false');
                console.log('‚úÖ Fallback modal aberto');
            };
            
            console.log('‚úÖ Fallback configurado para checkout');
        } else {
            console.error('‚ùå Elementos cr√≠ticos n√£o encontrados para fallback');
        }

        // Garantir que sistema de pricing funcione b√°sico
        if (!window.PricingCalculator && !window.updatePricing) {
            console.log('üîß Criando sistema de pricing b√°sico...');
            
            window.updatePricing = function() {
                console.log('üìä Fallback pricing executado');
                // Implementa√ß√£o b√°sica de pricing
                const totalElement = document.getElementById('summaryTotal');
                if (totalElement) {
                    const currentValue = totalElement.getAttribute('data-current-value') || '0.00'; // Sem fallback fixo
                    totalElement.textContent = `$${currentValue}`;
                }
            };
            
            // Executar uma vez para definir valor inicial
            setTimeout(() => {
                window.updatePricing();
            }, 500);
        }
    }

    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    validateDiscountCode() {
        console.log('üé´ Validando c√≥digo de desconto...');
        // Implementa√ß√£o ser√° adicionada conforme necess√°rio
    }

    // M√©todo para adicionar elementos dinamicamente
    addElement(key, element) {
        if (element) {
            this.elements[key] = element;
            console.log(`‚úÖ Elemento ${key} adicionado dinamicamente`);
        }
    }

    // M√©todo para verificar se um elemento existe
    hasElement(key) {
        return this.elements.hasOwnProperty(key) && this.elements[key];
    }

    // M√©todo p√∫blico para debug
    getDebugInfo() {
        return {
            initialized: this.initialized,
            elementsFound: Object.keys(this.elements),
            hasWindow: {
                PricingCalculator: !!window.PricingCalculator,
                updatePricing: !!window.updatePricing,
                bookingCalendar: !!window.bookingCalendar,
                SummaryModal: !!window.SummaryModal
            }
        };
    }
}

// Fun√ß√£o de inicializa√ß√£o segura
function initializeBookingApp() {
    try {
        window.BookingApp = new BookingApp();
        
        // Aguardar um pouco antes de inicializar para garantir que outros scripts carregaram
        setTimeout(() => {
            window.BookingApp.init();
            
            // Debug info se necess√°rio
            if (window.BookingApp.debugMode) {
                console.log('üîç BookingApp Debug Info:', window.BookingApp.getDebugInfo());
            }
        }, 500);
        
    } catch (error) {
        console.error('‚ùå Falha cr√≠tica ao inicializar BookingApp:', error);
        
        // Fallback absoluto
        setTimeout(() => {
            const button = document.getElementById('openSummaryBtn');
            const modal = document.getElementById('summaryModal');
            
            if (button && modal) {
                button.onclick = function(e) {
                    e.preventDefault();
                    modal.classList.remove('hidden');
                    console.log('‚úÖ Fallback absoluto executado');
                };
            }
        }, 1000);
    }
}

// Inicializar quando DOM estiver pronto
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeBookingApp);
} else {
    initializeBookingApp();
}

// Export para uso global
window.BookingApp = window.BookingApp || {};

// Compatibilidade com sistemas antigos
window.initBookingApp = initializeBookingApp;
